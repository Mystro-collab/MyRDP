name: SSH-Access

on:
  workflow_dispatch:

jobs:
  secure-ssh:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Create SSH User with Secure Password
        run: |
          # Generate strong random password
          PASSWORD=$(openssl rand -base64 32 | tr -d "=+/" | cut -c1-25)
          
          # Create user with sudo privileges
          sudo useradd -m -s /bin/bash sshuser
          echo "sshuser:$PASSWORD" | sudo chpasswd
          sudo usermod -aG sudo sshuser
          
          echo "SSH_PASSWORD=$PASSWORD" >> $GITHUB_ENV

      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh

      - name: Establish Tailscale Connection
        run: |
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-runner-$GITHUB_RUN_ID --ssh
          
          # Get Tailscale IP
          sleep 5
          TAILSCALE_IP=$(tailscale ip -4)
          echo "TAILSCALE_IP=$TAILSCALE_IP" >> $GITHUB_ENV

      - name: Configure SSH Access
        run: |
          # Ensure SSH is running
          sudo systemctl enable ssh
          sudo systemctl start ssh
          
          # Allow password authentication
          sudo sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config
          sudo sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_config
          sudo sed -i 's/#PubkeyAuthentication yes/PubkeyAuthentication yes/' /etc/ssh/sshd_config
          sudo systemctl restart ssh

      - name: Display Connection Info
        run: |
          echo "========================================="
          echo "SSH ACCESS INFORMATION"
          echo "========================================="
          echo "Tailscale IP: $TAILSCALE_IP"
          echo "Username: sshuser"
          echo "Password: $SSH_PASSWORD"
          echo ""
          echo "Connect from your PC with:"
          echo "ssh sshuser@$TAILSCALE_IP"
          echo "========================================="

      - name: Maintain Connection
        run: |
          echo "Connection active. Workflow will run for 6 hours or until manually cancelled."
          while true; do
            echo "[$(date)] SSH Active - Tailscale IP: $TAILSCALE_IP"
            sleep 300
          done
